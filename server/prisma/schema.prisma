datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model HealthProbe {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model AuthUser {
  id               String                @id @default(uuid())
  email            String                @unique
  passwordHash     String                @map("password_hash")
  fullName         String?               @map("full_name")
  avatarObjectName String?               @map("avatar_object_name")
  status           AuthUserStatus        @default(PENDING_VERIFICATION)
  emailVerifiedAt  DateTime?             @map("email_verified_at")
  mfaEnabled       Boolean               @default(false) @map("mfa_enabled")
  lastLoginAt      DateTime?             @map("last_login_at")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  sessions         AuthSession[]
  passwordResets   AuthPasswordReset[]
  emailVerifications AuthEmailVerification[]
  roleAssignments  AuthRoleAssignment[]
  serviceTokens    AuthServiceToken[]
  events           AuthEventLedger[]
  authoredPolicies AuthPolicy[]          @relation("AuthPolicyCreatedBy")
  policyRevisions  AuthPolicyRevision[]  @relation("AuthPolicyRevisionCreatedBy")
  evidenceUploads  Evidence[]
  tasksCreated     Task[]                @relation("TaskCreatedBy")
  tasksAssigned    Task[]                @relation("TaskAssignedUser")
  taskEvents       TaskEvent[]           @relation("TaskEventActor")
  taskAssignments  TaskAssignment[]      @relation("TaskAssignmentUser")
  taskDelegations  TaskAssignment[]      @relation("TaskDelegatedBy")
  taskEvidenceReviews TaskEvidenceLink[] @relation("TaskEvidenceReviewer")
  reportExports    ReportExport[]
  reportAuditLogs  ReportAuditLog[]

  @@map("auth_users")
  @@index([status])
  @@index([createdAt])
}

model AuthSession {
  id               String      @id @default(uuid())
  userId           String      @map("user_id")
  refreshTokenHash String      @map("refresh_token_hash")
  userAgent        String?     @map("user_agent")
  ipAddress        String?     @map("ip_address")
  expiresAt        DateTime    @map("expires_at")
  revokedAt        DateTime?   @map("revoked_at")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  user             AuthUser    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth_sessions")
}

model AuthPasswordReset {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  user       AuthUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, tokenHash])
  @@map("auth_password_resets")
}

model AuthEmailVerification {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  user       AuthUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, tokenHash])
  @@map("auth_email_verifications")
}

model AuthRole {
  id              String               @id @default(uuid())
  tenantId        String?              @map("tenant_id")
  domain          String?
  name            String
  description     String?
  isSystemDefault Boolean              @default(false) @map("is_system_default")
  inheritsRoleId  String?              @map("inherits_role_id")
  reviewCadenceDays Int?               @map("review_cadence_days")
  metadata        Json?
  archivedAt      DateTime?            @map("archived_at")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  assignments     AuthRoleAssignment[]
  inheritsRole    AuthRole?            @relation("AuthRoleInheritance", fields: [inheritsRoleId], references: [id], onDelete: SetNull)
  childRoles      AuthRole[]           @relation("AuthRoleInheritance")

  @@unique([name])
  @@index([tenantId])
  @@index([domain])
  @@index([inheritsRoleId])
  @@map("auth_roles")
}

model AuthRoleAssignment {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedBy String?  @map("assigned_by")
  assignedAt DateTime @default(now()) @map("assigned_at")
  expiresAt  DateTime? @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  domain     String?  @map("domain")
  user       AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       AuthRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roleId])
  @@index([domain])
  @@unique([userId, roleId])
  @@map("auth_role_assignments")
}

model AuthServiceToken {
  id         String    @id @default(uuid())
  userId     String?   @map("user_id")
  name       String
  tokenHash  String    @map("token_hash")
  scopes     Json?
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  user       AuthUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("auth_service_tokens")
}

model AuthEventLedger {
  id        String    @id @default(uuid())
  userId    String?   @map("user_id")
  eventType String    @map("event_type")
  payload   Json?
  createdAt DateTime  @default(now()) @map("created_at")
  user      AuthUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("auth_event_ledger")
}

model AuthPolicy {
  id          String                @id @default(uuid())
  type        String
  subject     String?
  domain      String?
  object      String?
  action      String?
  effect      String                @default("allow")
  description String?
  metadata    Json?
  createdById String?               @map("created_by_id")
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")
  deletedAt   DateTime?             @map("deleted_at")
  createdBy   AuthUser?             @relation("AuthPolicyCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  revisions   AuthPolicyRevision[]

  @@map("auth_policies")
  @@index([type])
  @@index([subject])
  @@index([domain])
  @@index([object])
  @@index([action])
}

model AuthPolicyRevision {
  id             String    @id @default(uuid())
  policyId       String?   @map("policy_id")
  changeType     String    @map("change_type")
  justification  String?
  summary        String?
  payload        Json?
  createdById    String?   @map("created_by_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  policy         AuthPolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)
  createdBy      AuthUser?  @relation("AuthPolicyRevisionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@map("auth_policy_revisions")
  @@index([policyId])
  @@index([createdById])
}

enum AuthUserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  INVITED
}

enum AuditLogAction {
  CREATE
  UPDATE
  DELETE
}

model AuditLog {
  id             String         @id @default(uuid())
  model          String
  action         AuditLogAction
  recordId       String?        @map("record_id")
  changes        Json?          @map("changes")
  affectedUserId String?        @map("affected_user_id")
  performedById  String?        @map("performed_by_id")
  before         Json?
  after          Json?
  ip             String?
  userAgent      String?        @map("user_agent")
  timestamp      DateTime       @default(now()) @map("created_at")

  @@index([model])
  @@index([performedById])
  @@index([affectedUserId])
  @@map("audit_logs")
}

model CustomerBrandingSetting {
  id                String   @id @default("default")
  name              String
  sidebarTitle      String   @map("sidebar_title")
  logoObjectName    String?  @map("logo_object_name")
  searchPlaceholder String   @map("search_placeholder")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("customer_branding_settings")
}

model Probe {
  id                       String            @id @default(uuid())
  slug                     String            @unique
  name                     String
  description              String?
  ownerEmail               String            @map("owner_email")
  ownerTeam                String?           @map("owner_team")
  status                   ProbeStatus       @default(DRAFT)
  frameworkBindings        String[]          @default([]) @map("framework_bindings")
  evidenceSchema           Json?             @map("evidence_schema")
  tags                     String[]          @default([])
  environmentOverlays      Json?             @map("environment_overlays")
  sdkVersionMin            String?           @map("sdk_version_min")
  sdkVersionTarget         String?           @map("sdk_version_target")
  heartbeatIntervalSeconds Int?              @map("heartbeat_interval_seconds")
  alertChannels            String[]          @default([]) @map("alert_channels")
  lastDeployedAt           DateTime?         @map("last_deployed_at")
  metadata                 Json?
  createdAt                DateTime          @default(now()) @map("created_at")
  updatedAt                DateTime          @updatedAt @map("updated_at")
  deployments              ProbeDeployment[]
  schedules                ProbeSchedule[]
  metrics                  ProbeMetric?
  credentials              ProbeCredential[]
  events                   ProbeEvent[]

  @@index([status])
  @@map("probes")
}

model ProbeDeployment {
  id                String                 @id @default(uuid())
  probeId           String                 @map("probe_id")
  version           String
  environment       String
  canaryPercent     Int?                   @map("canary_percent")
  status            ProbeDeploymentStatus  @default(PENDING)
  summary           String?
  manifest          Json?
  metadata          Json?
  selfTestSnapshot  Json?                  @map("self_test_snapshot")
  startedAt         DateTime?              @map("started_at")
  completedAt       DateTime?              @map("completed_at")
  rolledBackAt      DateTime?              @map("rolled_back_at")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  probe             Probe                  @relation(fields: [probeId], references: [id], onDelete: Cascade)

  @@index([probeId])
  @@index([probeId, environment])
  @@map("probe_deployments")
}

model ProbeSchedule {
  id             String                @id @default(uuid())
  probeId        String                @map("probe_id")
  type           ProbeScheduleType
  expression     String?
  priority       ProbeSchedulePriority @default(NORMAL)
  status         ProbeScheduleStatus   @default(ACTIVE)
  controls       String[]              @default([])
  triggerMetadata Json?                @map("trigger_metadata")
  metadata       Json?
  lastRunAt      DateTime?             @map("last_run_at")
  nextRunAt      DateTime?             @map("next_run_at")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  probe          Probe                 @relation(fields: [probeId], references: [id], onDelete: Cascade)

  @@index([probeId])
  @@index([probeId, status])
  @@map("probe_schedules")
}

model ProbeMetric {
  id                         String               @id @default(uuid())
  probeId                    String               @unique @map("probe_id")
  heartbeatStatus            ProbeHeartbeatStatus @default(UNKNOWN) @map("heartbeat_status")
  heartbeatIntervalSeconds   Int?                 @map("heartbeat_interval_seconds")
  lastHeartbeatAt            DateTime?            @map("last_heartbeat_at")
  failureCount24h            Int                  @default(0) @map("failure_count_24h")
  latencyP95Ms               Int?                 @map("latency_p95_ms")
  latencyP99Ms               Int?                 @map("latency_p99_ms")
  errorRatePercent           Float?               @map("error_rate_percent")
  evidenceThroughputPerHour  Int?                 @map("evidence_throughput_per_hour")
  lastErrorCode              String?              @map("last_error_code")
  metadata                   Json?
  createdAt                  DateTime             @default(now()) @map("created_at")
  updatedAt                  DateTime             @updatedAt @map("updated_at")
  probe                      Probe                @relation(fields: [probeId], references: [id], onDelete: Cascade)

  @@map("probe_metrics")
}

model ProbeCredential {
  id             String                 @id @default(uuid())
  probeId        String                 @map("probe_id")
  type           ProbeCredentialType
  credentialHash String                 @map("credential_hash")
  status         ProbeCredentialStatus  @default(ACTIVE)
  issuedAt       DateTime               @default(now()) @map("issued_at")
  expiresAt      DateTime?              @map("expires_at")
  rotatedAt      DateTime?              @map("rotated_at")
  metadata       Json?
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")
  probe          Probe                  @relation(fields: [probeId], references: [id], onDelete: Cascade)

  @@index([probeId])
  @@map("probe_credentials")
}

model ProbeEvent {
  id        String        @id @default(uuid())
  probeId   String        @map("probe_id")
  type      ProbeEventType
  payload   Json?
  createdAt DateTime       @default(now()) @map("created_at")
  probe     Probe          @relation(fields: [probeId], references: [id], onDelete: Cascade)

  @@index([probeId])
  @@index([createdAt])
  @@map("probe_events")
}

enum ProbeStatus {
  DRAFT
  ACTIVE
  DEPRECATED
}

enum ProbeDeploymentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK
  CANCELLED
}

enum ProbeScheduleType {
  CRON
  EVENT
  ADHOC
}

enum ProbeSchedulePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ProbeScheduleStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum ProbeHeartbeatStatus {
  OPERATIONAL
  DEGRADED
  OUTAGE
  UNKNOWN
}

enum ProbeCredentialType {
  API_KEY
  MTLS
  TOKEN
}

enum ProbeCredentialStatus {
  ACTIVE
  INACTIVE
  REVOKED
}

enum ProbeEventType {
  HEARTBEAT
  EVIDENCE
  FAILURE
  DEPLOYMENT
  RUN
}

model Check {
  id              String       @id @default(uuid())
  name            String
  description     String?
  type            CheckType    @default(AUTOMATED)
  status          CheckStatus  @default(DRAFT)
  severityDefault CheckSeverity @default(MEDIUM) @map("severity_default")
  controlId       String?      @map("control_id")
  probeId         String?      @map("probe_id")
  version         Int          @default(1)
  frequency       String?
  metadata        Json?
  tags            String[]     @default([])
  createdBy       String?      @map("created_by")
  updatedBy       String?      @map("updated_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  lastRunAt       DateTime?    @map("last_run_at")
  nextRunAt       DateTime?    @map("next_run_at")
  readyAt         DateTime?    @map("ready_at")
  retiredAt       DateTime?    @map("retired_at")
  versions        CheckVersion[]
  results         CheckResult[]
  reviewQueue     ReviewQueueItem[]
  controlLinks    CheckControlLink[]
  notifications   CheckNotification[]
  evidenceLinks   EvidenceLink[]
  tasks           Task[]
  control         Control?     @relation(fields: [controlId], references: [id], onDelete: SetNull)

  @@map("checks")
  @@index([status])
  @@index([controlId])
  @@index([probeId])
}

model CheckVersion {
  id             String      @id @default(uuid())
  checkId        String      @map("check_id")
  version        Int
  statusSnapshot CheckStatus @map("status_snapshot")
  definition     Json?
  diff           Json?
  notes          String?
  createdBy      String?     @map("created_by")
  createdAt      DateTime    @default(now()) @map("created_at")
  check          Check       @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@unique([checkId, version])
  @@map("check_versions")
}

model CheckResult {
  id               String                        @id @default(uuid())
  checkId          String                        @map("check_id")
  controlId        String?                       @map("control_id")
  runContext       String?                       @map("run_context")
  triggerSource    String?                       @map("trigger_source")
  status           CheckResultStatus             @default(PENDING_REVIEW)
  severity         CheckSeverity                 @default(MEDIUM)
  evidenceLinkId   String?                       @map("evidence_link_id")
  notes            String?
  metadata         Json?
  rawOutput        Json?                         @map("raw_output")
  executedAt       DateTime                      @default(now()) @map("executed_at")
  validatedAt      DateTime?                     @map("validated_at")
  publishedAt      DateTime?                     @map("published_at")
  publicationState CheckResultPublicationState   @default(PENDING) @map("publication_state")
  createdBy        String?                       @map("created_by")
  updatedAt        DateTime?                     @map("updated_at")
  check            Check                         @relation(fields: [checkId], references: [id], onDelete: Cascade)
  reviewQueueItem  ReviewQueueItem?              @relation("CheckResultReviewQueue")
  notifications    CheckNotification[]
  control          Control?                      @relation(fields: [controlId], references: [id], onDelete: SetNull)

  @@index([checkId])
  @@index([controlId])
  @@index([status])
  @@map("check_results")
}

model ReviewQueueItem {
  id                String             @id @default(uuid())
  checkId           String             @map("check_id")
  resultId          String?            @unique @map("result_id")
  assignedTo        String?            @map("assigned_to")
  dueAt             DateTime?          @map("due_at")
  priority          ReviewQueuePriority @default(MEDIUM)
  state             ReviewQueueState   @default(OPEN)
  slaMinutes        Int?               @map("sla_minutes")
  acknowledgedAt    DateTime?          @map("acknowledged_at")
  completedAt       DateTime?          @map("completed_at")
  escalationLevel   String?            @map("escalation_level")
  evidenceBundleId  String?            @map("evidence_bundle_id")
  metadata          Json?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  check             Check              @relation(fields: [checkId], references: [id], onDelete: Cascade)
  result            CheckResult?       @relation("CheckResultReviewQueue", fields: [resultId], references: [id])

  @@index([checkId])
  @@index([state])
  @@map("review_queue_items")
}

model CheckControlLink {
  id                   String                       @id @default(uuid())
  checkId              String                       @map("check_id")
  controlId            String                       @map("control_id")
  weight               Float?                       @default(1)
  enforcementLevel     CheckControlEnforcementLevel @default(OPTIONAL) @map("enforcement_level")
  assertionType        String?                      @map("assertion_type")
  frequencyCadence     String?                      @map("frequency_cadence")
  evidenceRequirements String?                      @map("evidence_requirements")
  metadata             Json?
  createdAt            DateTime                     @default(now()) @map("created_at")
  updatedAt            DateTime                     @updatedAt @map("updated_at")
  check                Check                        @relation(fields: [checkId], references: [id], onDelete: Cascade)
  control              Control                      @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([checkId, controlId])
  @@map("check_control_links")
}

model CheckNotification {
  id             String                   @id @default(uuid())
  checkId        String                   @map("check_id")
  resultId       String?                  @map("result_id")
  template       String
  channel        String?
  recipient      String?
  status         CheckNotificationStatus  @default(PENDING)
  correlationId  String?                  @map("correlation_id")
  metadata       Json?
  sentAt         DateTime?                @map("sent_at")
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAt      DateTime                 @updatedAt @map("updated_at")
  check          Check                    @relation(fields: [checkId], references: [id], onDelete: Cascade)
  result         CheckResult?             @relation(fields: [resultId], references: [id])

  @@index([checkId])
  @@index([resultId])
  @@map("check_notifications")
}

model Control {
  id                     String                  @id @default(uuid())
  slug                   String                  @unique
  title                  String
  description            String?
  rationale              String?
  implementationGuidance String?                 @map("implementation_guidance")
  ownerTeam              String?                 @map("owner_team")
  status                 ControlStatus           @default(DRAFT)
  riskTier               ControlRiskTier         @default(MEDIUM) @map("risk_tier")
  enforcementLevel       ControlEnforcementLevel @default(ADVISORY) @map("enforcement_level")
  version                Int                     @default(1)
  domain                 String?
  category               String?
  subCategory            String?                 @map("sub_category")
  tags                   String[]                @default([])
  metadata               Json?
  impactWeight           Float?                  @map("impact_weight")
  createdBy              String?                 @map("created_by")
  updatedBy              String?                 @map("updated_by")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  publishedAt            DateTime?               @map("published_at")
  deprecatedAt           DateTime?               @map("deprecated_at")
  deprecatedReason       String?                 @map("deprecated_reason")
  remediationNotes       String?                 @map("remediation_notes")
  frameworkLinks         ControlFrameworkLink[]
  checkLinks             CheckControlLink[]
  checks                 Check[]
  scores                 ControlScore[]
  auditEvents            ControlAuditEvent[]
  results                CheckResult[]
  evidenceLinks          EvidenceLink[]
  tasks                  Task[]
  reportScores           ReportScore[]

  @@map("controls")
  @@index([status])
  @@index([riskTier])
  @@index([domain])
  @@index([category])
}

model ControlFrameworkLink {
  id                 String                     @id @default(uuid())
  controlId          String                     @map("control_id")
  frameworkId        String?                    @map("framework_id")
  frameworkControlId String?                    @map("framework_control_id")
  coverageLevel      ControlCoverageLevel       @default(PARTIAL) @map("coverage_level")
  status             ControlFrameworkLinkStatus @default(ACTIVE)
  evidenceReferences String[]                   @default([]) @map("evidence_references")
  effectiveFrom      DateTime?                  @map("effective_from")
  effectiveTo        DateTime?                  @map("effective_to")
  notes              String?
  metadata           Json?
  createdAt          DateTime                   @default(now()) @map("created_at")
  updatedAt          DateTime                   @updatedAt @map("updated_at")
  control            Control                    @relation(fields: [controlId], references: [id], onDelete: Cascade)
  framework          Framework?                 @relation(fields: [frameworkId], references: [id], onDelete: SetNull)
  frameworkControl   FrameworkControl?          @relation(fields: [frameworkControlId], references: [id], onDelete: SetNull)

  @@map("control_framework_links")
  @@index([controlId])
  @@index([frameworkId])
  @@index([frameworkControlId])
  @@index([status])
}

model ControlScore {
  id             String                     @id @default(uuid())
  controlId      String                     @map("control_id")
  granularity    ControlScoreGranularity    @default(DAILY)
  windowStart    DateTime                   @map("window_start")
  windowEnd      DateTime                   @map("window_end")
  score          Float
  classification ControlScoreClassification
  sampleSize     Int                        @default(0) @map("sample_size")
  numerator      Float                      @default(0)
  denominator    Float                      @default(0)
  metadata       Json?
  createdAt      DateTime                   @default(now()) @map("created_at")
  updatedAt      DateTime                   @updatedAt @map("updated_at")
  control        Control                    @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("control_scores")
  @@index([controlId])
  @@unique([controlId, granularity, windowStart])
}

model ControlAuditEvent {
  id            String   @id @default(uuid())
  controlId     String   @map("control_id")
  action        String
  actorId       String?  @map("actor_id")
  changeSummary String?  @map("change_summary")
  payloadBefore Json?    @map("payload_before")
  payloadAfter  Json?    @map("payload_after")
  comment       String?
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  control       Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("control_audit_events")
  @@index([controlId])
}

enum CheckType {
  AUTOMATED
  MANUAL
  HYBRID
}

enum CheckStatus {
  DRAFT
  READY_FOR_VALIDATION
  ACTIVE
  RETIRED
}

enum CheckSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CheckResultStatus {
  PASS
  FAIL
  WARNING
  PENDING_REVIEW
  ERROR
}

enum CheckResultPublicationState {
  PENDING
  VALIDATED
  PUBLISHED
  REJECTED
}

enum ReviewQueueState {
  OPEN
  IN_PROGRESS
  COMPLETED
  ESCALATED
}

enum ReviewQueuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CheckControlEnforcementLevel {
  OPTIONAL
  RECOMMENDED
  MANDATORY
}

enum CheckNotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum ControlStatus {
  DRAFT
  ACTIVE
  DEPRECATED
}

enum ControlRiskTier {
  LOW
  MEDIUM
  HIGH
}

enum ControlEnforcementLevel {
  ADVISORY
  MANDATORY
}

enum ControlCoverageLevel {
  FULL
  PARTIAL
  COMPENSATING
}

enum ControlFrameworkLinkStatus {
  ACTIVE
  IN_REVIEW
  RETIRED
}

enum ControlScoreGranularity {
  DAILY
  WEEKLY
  MONTHLY
}

enum ControlScoreClassification {
  PASSING
  NEEDS_ATTENTION
  FAILING
}

enum FrameworkStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum FrameworkVersionStatus {
  DRAFT
  PENDING_APPROVAL
  PUBLISHED
  RETIRED
}

enum FrameworkControlStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum FrameworkMappingStrength {
  EXACT
  PARTIAL
  INFORMATIVE
}

enum FrameworkMappingStatus {
  ACTIVE
  IN_REVIEW
  RETIRED
}

enum FrameworkJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum EvidenceRetentionState {
  ACTIVE
  ARCHIVED
  LEGAL_HOLD
  PURGE_SCHEDULED
}

enum EvidenceSource {
  MANUAL
  PROBE
  API
  IMPORT
}

enum EvidenceEventAction {
  UPLOAD_REQUESTED
  UPLOAD_CONFIRMED
  DOWNLOAD_ISSUED
  METADATA_UPDATED
  LINK_ATTACHED
  LINK_REMOVED
  RETENTION_UPDATED
}

model EvidenceRetentionPolicy {
  id                 String    @id @default(uuid())
  name               String
  retentionMonths    Int       @map("retention_months")
  archiveAfterMonths Int?      @map("archive_after_months")
  description        String?
  isDefault          Boolean   @default(false) @map("is_default")
  legalHoldAllowed   Boolean   @default(true) @map("legal_hold_allowed")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  evidence           Evidence[]

  @@map("evidence_retention_policies")
  @@index([isDefault])
}

model Evidence {
  id                 String                 @id @default(uuid())
  displayName        String                 @map("display_name")
  description        String?
  storageKey         String                 @unique @map("storage_key")
  objectName         String                 @map("object_name")
  bucket             String
  mimeType           String                 @map("mime_type")
  size               Int
  checksum           String
  version            Int                    @default(1)
  source             EvidenceSource         @default(MANUAL)
  tags               String[]               @default([])
  retentionState     EvidenceRetentionState @default(ACTIVE) @map("retention_state")
  retentionPolicyId  String?                @map("retention_policy_id")
  purgeScheduledFor  DateTime?              @map("purge_scheduled_for")
  archivedAt         DateTime?              @map("archived_at")
  legalHoldAppliedAt DateTime?              @map("legal_hold_applied_at")
  metadata           Json?
  uploaderId         String                 @map("uploader_id")
  downloadCount      Int                    @default(0) @map("download_count")
  createdAt          DateTime               @default(now()) @map("created_at")
  updatedAt          DateTime               @updatedAt @map("updated_at")
  retentionPolicy    EvidenceRetentionPolicy? @relation(fields: [retentionPolicyId], references: [id], onDelete: SetNull)
  links              EvidenceLink[]
  events             EvidenceEvent[]
  versions           EvidenceVersion[]
  uploader           AuthUser               @relation(fields: [uploaderId], references: [id], onDelete: Restrict)
  taskLinks          TaskEvidenceLink[]

  @@map("evidence")
  @@index([retentionState])
  @@index([retentionPolicyId])
  @@index([createdAt])
  @@index([uploaderId])
}

model EvidenceLink {
  id            String   @id @default(uuid())
  evidenceId    String   @map("evidence_id")
  controlId     String?  @map("control_id")
  checkId       String?  @map("check_id")
  taskReference String?  @map("task_reference")
  role          String?
  justification String?
  linkedBy      String?  @map("linked_by")
  linkedAt      DateTime @default(now()) @map("linked_at")
  metadata      Json?
  evidence      Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  control       Control? @relation(fields: [controlId], references: [id], onDelete: SetNull)
  check         Check?   @relation(fields: [checkId], references: [id], onDelete: SetNull)

  @@map("evidence_links")
  @@index([controlId])
  @@index([checkId])
  @@index([taskReference])
}

model EvidenceEvent {
  id         String              @id @default(uuid())
  evidenceId String              @map("evidence_id")
  actorId    String?             @map("actor_id")
  action     EvidenceEventAction
  ipAddress  String?             @map("ip_address")
  userAgent  String?             @map("user_agent")
  metadata   Json?
  createdAt  DateTime            @default(now()) @map("created_at")
  evidence   Evidence            @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@map("evidence_events")
  @@index([evidenceId])
  @@index([action])
}

model EvidenceVersion {
  id         String   @id @default(uuid())
  evidenceId String   @map("evidence_id")
  version    Int
  checksum   String
  storageKey String   @map("storage_key")
  size       Int
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  createdBy  String?  @map("created_by")
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@map("evidence_versions")
  @@unique([evidenceId, version])
}

model Framework {
  id               String              @id @default(uuid())
  slug             String              @unique
  title            String
  description      String?
  domain           String?
  jurisdiction     String?
  publisher        String?
  status           FrameworkStatus     @default(DRAFT)
  validFrom        DateTime?           @map("valid_from")
  validTo          DateTime?           @map("valid_to")
  tags             String[]            @default([])
  metadata         Json?
  activeVersionId  String?             @map("active_version_id") @unique
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  activeVersion    FrameworkVersion?   @relation("ActiveFrameworkVersion", fields: [activeVersionId], references: [id])
  versions         FrameworkVersion[]
  controls         FrameworkControl[]
  controlLinks     ControlFrameworkLink[]
  sourceMappings   FrameworkMapping[]  @relation("SourceFramework")
  targetMappings   FrameworkMapping[]  @relation("TargetFramework")
  imports          FrameworkImport[]
  exports          FrameworkExport[]
  auditLogs        FrameworkAuditLog[]
  tasks            Task[]
  reportScores     ReportScore[]

  @@map("frameworks")
  @@index([status])
  @@index([jurisdiction])
  @@index([publisher])
  @@index([domain])
}

model FrameworkVersion {
  id              String                  @id @default(uuid())
  frameworkId     String                  @map("framework_id")
  version         String
  status          FrameworkVersionStatus  @default(DRAFT)
  changelog       String?
  diffHash        String?                 @map("diff_hash")
  diffSummary     Json?                   @map("diff_summary")
  approvals       Json?
  metadata        Json?
  effectiveFrom   DateTime?               @map("effective_from")
  effectiveTo     DateTime?               @map("effective_to")
  publishedAt     DateTime?               @map("published_at")
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  framework       Framework               @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  controls        FrameworkControl[]
  activeFramework Framework?              @relation("ActiveFrameworkVersion")

  @@map("framework_versions")
  @@index([frameworkId])
  @@index([status])
  @@unique([frameworkId, version])
}

model FrameworkControl {
  id                   String                 @id @default(uuid())
  frameworkId          String                 @map("framework_id")
  frameworkVersionId   String?                @map("framework_version_id")
  code                 String
  title                String
  description          String?
  category             String?
  riskLevel            String?                @map("risk_level")
  status               FrameworkControlStatus @default(DRAFT)
  tags                 String[]               @default([])
  evidenceRequirements Json?                  @map("evidence_requirements")
  metadata             Json?
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  framework            Framework              @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  frameworkVersion     FrameworkVersion?      @relation(fields: [frameworkVersionId], references: [id], onDelete: SetNull)
  sourceMappings       FrameworkMapping[]     @relation("SourceControl")
  targetMappings       FrameworkMapping[]     @relation("TargetControl")
  controlLinks         ControlFrameworkLink[]

  @@map("framework_controls")
  @@unique([frameworkId, code])
  @@index([frameworkVersionId])
  @@index([status])
}

model FrameworkMapping {
  id                String                   @id @default(uuid())
  sourceFrameworkId String                   @map("source_framework_id")
  sourceControlId   String                   @map("source_control_id")
  targetFrameworkId String                   @map("target_framework_id")
  targetControlId   String                   @map("target_control_id")
  mappingStrength   FrameworkMappingStrength @default(EXACT) @map("mapping_strength")
  status            FrameworkMappingStatus   @default(ACTIVE)
  justification     String?
  tags              String[]                 @default([])
  metadata          Json?
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")
  sourceFramework   Framework                @relation("SourceFramework", fields: [sourceFrameworkId], references: [id], onDelete: Cascade)
  targetFramework   Framework                @relation("TargetFramework", fields: [targetFrameworkId], references: [id], onDelete: Cascade)
  sourceControl     FrameworkControl         @relation("SourceControl", fields: [sourceControlId], references: [id], onDelete: Cascade)
  targetControl     FrameworkControl         @relation("TargetControl", fields: [targetControlId], references: [id], onDelete: Cascade)
  history           FrameworkMappingHistory[]

  @@map("framework_mappings")
  @@index([sourceFrameworkId])
  @@index([targetFrameworkId])
  @@index([mappingStrength])
  @@unique([sourceControlId, targetControlId])
}

model FrameworkMappingHistory {
  id            String           @id @default(uuid())
  mappingId     String           @map("mapping_id")
  changeType    String           @map("change_type")
  actorId       String?          @map("actor_id")
  payloadBefore Json?            @map("payload_before")
  payloadAfter  Json?            @map("payload_after")
  justification String?
  metadata      Json?
  createdAt     DateTime         @default(now()) @map("created_at")
  mapping       FrameworkMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@map("framework_mapping_history")
  @@index([mappingId])
}

model FrameworkImport {
  id           String            @id @default(uuid())
  frameworkId  String?           @map("framework_id")
  source       String?
  format       String?
  status       FrameworkJobStatus @default(PENDING)
  artifactUri  String?           @map("artifact_uri")
  errorDetails Json?             @map("error_details")
  metadata     Json?
  startedAt    DateTime?         @map("started_at")
  completedAt  DateTime?         @map("completed_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  framework    Framework?        @relation(fields: [frameworkId], references: [id], onDelete: SetNull)

  @@map("framework_imports")
  @@index([frameworkId])
  @@index([status])
}

model FrameworkExport {
  id           String            @id @default(uuid())
  frameworkId  String?           @map("framework_id")
  format       String?
  status       FrameworkJobStatus @default(PENDING)
  destination  String?
  artifactUri  String?           @map("artifact_uri")
  errorDetails Json?             @map("error_details")
  metadata     Json?
  startedAt    DateTime?         @map("started_at")
  completedAt  DateTime?         @map("completed_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  framework    Framework?        @relation(fields: [frameworkId], references: [id], onDelete: SetNull)

  @@map("framework_exports")
  @@index([frameworkId])
  @@index([status])
}

model FrameworkAuditLog {
  id            String    @id @default(uuid())
  frameworkId   String?   @map("framework_id")
  entityType    String    @map("entity_type")
  entityId      String?   @map("entity_id")
  action        String
  actorId       String?   @map("actor_id")
  payloadBefore Json?     @map("payload_before")
  payloadAfter  Json?     @map("payload_after")
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")
  framework     Framework? @relation(fields: [frameworkId], references: [id], onDelete: SetNull)

  @@map("framework_audit_log")
  @@index([frameworkId])
  @@index([entityType])
}

enum TaskStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  AWAITING_EVIDENCE
  PENDING_VERIFICATION
  RESOLVED
  CLOSED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskSource {
  CHECK_FAILURE
  CONTROL_REMEDIATION
  MANUAL
  IMPORT
  OTHER
}

enum TaskEvidenceStatus {
  PENDING
  APPROVED
  REJECTED
}

model Task {
  id                      String            @id @default(uuid())
  title                   String
  description             String?
  priority                TaskPriority      @default(MEDIUM)
  status                  TaskStatus        @default(DRAFT)
  source                  TaskSource        @default(MANUAL)
  controlId               String?           @map("control_id")
  checkId                 String?           @map("check_id")
  frameworkId             String?           @map("framework_id")
  createdById             String?           @map("created_by")
  assigneeId              String?           @map("assignee_id")
  teamId                  String?           @map("team_id")
  delegationExpiresAt     DateTime?         @map("delegation_expires_at")
  slaDueAt                DateTime?         @map("sla_due_at")
  escalationLevel         Int               @default(0) @map("escalation_level")
  externalIssueKey        String?           @map("external_issue_key")
  externalProvider        String?           @map("external_provider")
  verificationRequired    Boolean           @default(true) @map("verification_required")
  verificationCompletedAt DateTime?         @map("verification_completed_at")
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")
  resolvedAt              DateTime?         @map("resolved_at")
  closedAt                DateTime?         @map("closed_at")
  control                 Control?          @relation(fields: [controlId], references: [id], onDelete: SetNull)
  check                   Check?            @relation(fields: [checkId], references: [id], onDelete: SetNull)
  framework               Framework?        @relation(fields: [frameworkId], references: [id], onDelete: SetNull)
  createdBy               AuthUser?         @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  assignee                AuthUser?         @relation("TaskAssignedUser", fields: [assigneeId], references: [id], onDelete: SetNull)
  events                  TaskEvent[]
  assignments             TaskAssignment[]
  evidenceLinks           TaskEvidenceLink[]
  metrics                 TaskSlaMetric?    @relation("TaskMetrics")

  @@map("tasks")
  @@index([status])
  @@index([assigneeId])
  @@index([teamId])
  @@index([slaDueAt])
  @@index([escalationLevel])
}

model TaskEvent {
  id        String    @id @default(uuid())
  taskId    String    @map("task_id")
  eventType String    @map("event_type")
  payload   Json?
  actorId   String?   @map("actor_id")
  actorType String?   @map("actor_type")
  origin    String?   @map("origin")
  createdAt DateTime  @default(now()) @map("created_at")
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  actor     AuthUser? @relation("TaskEventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@map("task_events")
  @@index([taskId])
  @@index([eventType])
  @@index([actorId])
}

model TaskAssignment {
  id                   String    @id @default(uuid())
  taskId               String    @map("task_id")
  assigneeId           String?   @map("assignee_id")
  teamId               String?   @map("team_id")
  delegatedById        String?   @map("delegated_by")
  delegationExpiresAt  DateTime? @map("delegation_expires_at")
  justification        String?
  createdAt            DateTime  @default(now()) @map("created_at")
  revokedAt            DateTime? @map("revoked_at")
  task                 Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignee             AuthUser? @relation("TaskAssignmentUser", fields: [assigneeId], references: [id], onDelete: SetNull)
  delegatedBy          AuthUser? @relation("TaskDelegatedBy", fields: [delegatedById], references: [id], onDelete: SetNull)

  @@map("task_assignments")
  @@index([taskId])
  @@index([assigneeId])
  @@index([teamId])
}

model TaskEvidenceLink {
  id                 String             @id @default(uuid())
  taskId             String             @map("task_id")
  evidenceId         String             @map("evidence_id")
  linkType           String?            @map("link_type")
  reviewerId         String?            @map("reviewer_id")
  verificationStatus TaskEvidenceStatus @default(PENDING) @map("verification_status")
  verifiedAt         DateTime?          @map("verified_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  task               Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  evidence           Evidence           @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  reviewer           AuthUser?          @relation("TaskEvidenceReviewer", fields: [reviewerId], references: [id], onDelete: SetNull)

  @@map("task_evidence_links")
  @@unique([taskId, evidenceId])
  @@index([verificationStatus])
}

model TaskSlaMetric {
  id                 String   @id @default(uuid())
  taskId             String   @map("task_id")
  timeToAcknowledge  Int?     @map("time_to_acknowledge")
  timeInStatus       Json?    @map("time_in_status")
  timeToClose        Int?     @map("time_to_close")
  breachCount        Int      @default(0) @map("breach_count")
  lastBreachAt       DateTime? @map("last_breach_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  task               Task     @relation("TaskMetrics", fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_sla_metrics")
  @@unique([taskId])
  @@index([lastBreachAt])
}

model ReportScore {
  id             String                  @id @default(uuid())
  frameworkId    String?                 @map("framework_id")
  controlId      String?                 @map("control_id")
  domain         String?
  granularity    ReportScoreGranularity  @default(DAILY)
  windowStart    DateTime                @map("window_start")
  windowEnd      DateTime                @map("window_end")
  averageScore   Float?                  @map("average_score")
  failingCount   Int                     @default(0) @map("failing_count")
  trendDelta     Float?                  @map("trend_delta")
  dimensions     Json?
  metadata       Json?
  createdAt      DateTime                @default(now()) @map("created_at")
  updatedAt      DateTime                @updatedAt @map("updated_at")
  framework      Framework?              @relation(fields: [frameworkId], references: [id], onDelete: SetNull)
  control        Control?                @relation(fields: [controlId], references: [id], onDelete: SetNull)

  @@map("report_scores")
  @@index([frameworkId])
  @@index([controlId])
  @@index([granularity])
  @@index([windowStart])
}

model ReportMetric {
  id          String             @id @default(uuid())
  metricType  ReportMetricType   @map("metric_type")
  scope       String?
  filtersHash String?            @map("filters_hash")
  windowStart DateTime?          @map("window_start")
  windowEnd   DateTime?          @map("window_end")
  payload     Json?
  createdAt   DateTime           @default(now()) @map("created_at")

  @@map("report_metrics")
  @@index([metricType])
  @@index([filtersHash])
}

model ReportExport {
  id                     String               @id @default(uuid())
  exportType             ReportExportType     @map("export_type") @default(FRAMEWORK_ATTESTATION)
  format                 ReportExportFormat   @default(JSON)
  status                 ReportExportStatus   @default(PENDING)
  filters                Json?
  schedule               Json?
  artifactBucket         String?              @map("artifact_bucket")
  artifactObjectName     String?              @map("artifact_object_name")
  artifactInlinePayload  Json?                @map("artifact_inline_payload")
  artifactInlineEncoding String?              @map("artifact_inline_encoding")
  failureReason          String?              @map("failure_reason")
  requestedById          String?              @map("requested_by_id")
  scheduledFor           DateTime?            @map("scheduled_for")
  completedAt            DateTime?            @map("completed_at")
  createdAt              DateTime             @default(now()) @map("created_at")
  updatedAt              DateTime             @updatedAt @map("updated_at")
  requestedBy            AuthUser?            @relation(fields: [requestedById], references: [id], onDelete: SetNull)
  auditLogs              ReportAuditLog[]

  @@map("report_exports")
  @@index([status])
  @@index([exportType])
  @@index([requestedById])
}

model ReportAuditLog {
  id        String    @id @default(uuid())
  exportId  String?   @map("export_id")
  eventType String    @map("event_type")
  payload   Json?
  actorId   String?   @map("actor_id")
  createdAt DateTime  @default(now()) @map("created_at")
  export    ReportExport? @relation(fields: [exportId], references: [id], onDelete: Cascade)
  actor     AuthUser? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("report_audit_log")
  @@index([exportId])
  @@index([actorId])
}

model ReportWidget {
  id        String   @id @default(uuid())
  tenantId  String?  @map("tenant_id")
  slug      String
  enabled   Boolean  @default(true)
  config    Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("report_widgets")
  @@unique([tenantId, slug])
  @@index([tenantId])
}

enum ReportScoreGranularity {
  DAILY
  WEEKLY
  MONTHLY
}

enum ReportMetricType {
  FRAMEWORK
  CONTROL_HEALTH
  REMEDIATION
  EVIDENCE
}

enum ReportExportFormat {
  JSON
  CSV
  XLSX
}

enum ReportExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReportExportType {
  FRAMEWORK_ATTESTATION
  CONTROL_BREAKDOWN
  REMEDIATION_DIGEST
  EVIDENCE_OVERVIEW
}
